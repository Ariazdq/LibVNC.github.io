<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>LibVNCServer/LibVNCClient: vnc2mpg.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">LibVNCServer/LibVNCClient
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">vnc2mpg.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Simple movie writer for vnc; based on Libavformat API example from FFMPEGCopyright (c) 2003 Fabrice Bellard, 2004 Johannes E. Schindelin</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef M_PI</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define M_PI 3.1415926535897931</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &quot;avformat.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="rfbclient_8h.html">rfb/rfbclient.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define STREAM_FRAME_RATE 25 </span><span class="comment">/* 25 images/s */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/**************************************************************/</span></div>
<div class="line"><span class="comment">/* video output */</span></div>
<div class="line"></div>
<div class="line">AVFrame *<a name="a0"></a><a class="code" href="vnc2mpg_8c.html#a65f6cfcea30372e03b387bd67c2f8a8d">picture</a>, *<a name="a1"></a><a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a>;</div>
<div class="line">uint8_t *<a name="a2"></a><a class="code" href="vnc2mpg_8c.html#af6c914e8831b6f96e33a3b61324e459a">video_outbuf</a>;</div>
<div class="line"><span class="keywordtype">int</span> <a name="a3"></a><a class="code" href="vnc2mpg_8c.html#afd3bfa5add6477abed3eaa362c5702b4">frame_count</a>, <a name="a4"></a><a class="code" href="vnc2mpg_8c.html#a7933dd760b6ead0ba5b7fc2a28e0a870">video_outbuf_size</a>;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* add a video output stream */</span></div>
<div class="line">AVStream *<a name="a5"></a><a class="code" href="vnc2mpg_8c.html#a0f40e7e12b79ca55afa9a45a278baca2">add_video_stream</a>(AVFormatContext *oc, <span class="keywordtype">int</span> codec_id, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h)</div>
<div class="line">{</div>
<div class="line">    AVCodecContext *c;</div>
<div class="line">    AVStream *st;</div>
<div class="line"></div>
<div class="line">    st = av_new_stream(oc, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (!st) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not alloc stream\n&quot;</span>);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line">   </div>
<div class="line"><span class="preprocessor">#if LIBAVFORMAT_BUILD&lt;4629</span></div>
<div class="line"><span class="preprocessor"></span>    c = &amp;st-&gt;codec;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    c = st-&gt;codec;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    c-&gt;codec_id = codec_id;</div>
<div class="line">    c-&gt;codec_type = CODEC_TYPE_VIDEO;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* put sample parameters */</span></div>
<div class="line">    c-&gt;bit_rate = 800000;</div>
<div class="line">    <span class="comment">/* resolution must be a multiple of two */</span></div>
<div class="line">    c-&gt;width = w;  </div>
<div class="line">    c-&gt;height = h;</div>
<div class="line">    <span class="comment">/* frames per second */</span></div>
<div class="line"><span class="preprocessor">#if LIBAVCODEC_BUILD&lt;4754</span></div>
<div class="line"><span class="preprocessor"></span>    c-&gt;frame_rate = <a name="a6"></a><a class="code" href="vnc2mpg_8c.html#ad0fa7a6ac51a4021276c0a04dfe2283b">STREAM_FRAME_RATE</a>;  </div>
<div class="line">    c-&gt;frame_rate_base = 1;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    c-&gt;time_base.den = <a class="code" href="vnc2mpg_8c.html#ad0fa7a6ac51a4021276c0a04dfe2283b">STREAM_FRAME_RATE</a>;</div>
<div class="line">    c-&gt;time_base.num = 1;</div>
<div class="line">    c-&gt;pix_fmt = PIX_FMT_YUV420P;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    c-&gt;gop_size = 12; <span class="comment">/* emit one intra frame every twelve frames at most */</span></div>
<div class="line">    <span class="keywordflow">if</span> (c-&gt;codec_id == CODEC_ID_MPEG2VIDEO) {</div>
<div class="line">        <span class="comment">/* just for testing, we also add B frames */</span></div>
<div class="line">        c-&gt;max_b_frames = 2;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (c-&gt;codec_id == CODEC_ID_MPEG1VIDEO){</div>
<div class="line">        <span class="comment">/* needed to avoid using macroblocks in which some coeffs overflow </span></div>
<div class="line"><span class="comment">           this doesnt happen with normal video, it just happens here as the </span></div>
<div class="line"><span class="comment">           motion of the chroma plane doesnt match the luma plane */</span></div>
<div class="line">        c-&gt;mb_decision=2;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* some formats want stream headers to be seperate */</span></div>
<div class="line">    <span class="keywordflow">if</span>(!strcmp(oc-&gt;oformat-&gt;name, <span class="stringliteral">&quot;mp4&quot;</span>) || !strcmp(oc-&gt;oformat-&gt;name, <span class="stringliteral">&quot;mov&quot;</span>) || !strcmp(oc-&gt;oformat-&gt;name, <span class="stringliteral">&quot;3gp&quot;</span>))</div>
<div class="line">        c-&gt;flags |= CODEC_FLAG_GLOBAL_HEADER;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> st;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">AVFrame *<a name="a7"></a><a class="code" href="vnc2mpg_8c.html#add9b0822c69abf813cf6e35bae8bd5e0">alloc_picture</a>(<span class="keywordtype">int</span> pix_fmt, <span class="keywordtype">int</span> <a name="a8"></a><a class="code" href="vncev_8c.html#a667b04d7fb6ef46db4da4af554c5b6f7">width</a>, <span class="keywordtype">int</span> <a name="a9"></a><a class="code" href="vncev_8c.html#a64f9f90ece96c7bab4aee3deacf170e0">height</a>)</div>
<div class="line">{</div>
<div class="line">    AVFrame *<a class="code" href="vnc2mpg_8c.html#a65f6cfcea30372e03b387bd67c2f8a8d">picture</a>;</div>
<div class="line">    uint8_t *picture_buf;</div>
<div class="line">    <span class="keywordtype">int</span> size;</div>
<div class="line">    </div>
<div class="line">    picture = avcodec_alloc_frame();</div>
<div class="line">    <span class="keywordflow">if</span> (!picture)</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    size = avpicture_get_size(pix_fmt, width, height);</div>
<div class="line">    picture_buf = malloc(size);</div>
<div class="line">    <span class="keywordflow">if</span> (!picture_buf) {</div>
<div class="line">        av_free(picture);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    avpicture_fill((AVPicture *)picture, picture_buf, </div>
<div class="line">                   pix_fmt, width, height);</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="vnc2mpg_8c.html#a65f6cfcea30372e03b387bd67c2f8a8d">picture</a>;</div>
<div class="line">}</div>
<div class="line">    </div>
<div class="line"><span class="keywordtype">void</span> <a name="a10"></a><a class="code" href="vnc2mpg_8c.html#a600bf2cf174c8560ef9d88c3e0b8aa64">open_video</a>(AVFormatContext *oc, AVStream *st)</div>
<div class="line">{</div>
<div class="line">    AVCodec *codec;</div>
<div class="line">    AVCodecContext *c;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if LIBAVFORMAT_BUILD&lt;4629</span></div>
<div class="line"><span class="preprocessor"></span>    c = &amp;st-&gt;codec;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    c = st-&gt;codec;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">/* find the video encoder */</span></div>
<div class="line">    codec = avcodec_find_encoder(c-&gt;codec_id);</div>
<div class="line">    <span class="keywordflow">if</span> (!codec) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;codec not found\n&quot;</span>);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* open the codec */</span></div>
<div class="line">    <span class="keywordflow">if</span> (avcodec_open(c, codec) &lt; 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;could not open codec\n&quot;</span>);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="vnc2mpg_8c.html#af6c914e8831b6f96e33a3b61324e459a">video_outbuf</a> = NULL;</div>
<div class="line">    <span class="keywordflow">if</span> (!(oc-&gt;oformat-&gt;flags &amp; AVFMT_RAWPICTURE)) {</div>
<div class="line">        <span class="comment">/* allocate output buffer */</span></div>
<div class="line">        <span class="comment">/* XXX: API change will be done */</span></div>
<div class="line">        <a class="code" href="vnc2mpg_8c.html#a7933dd760b6ead0ba5b7fc2a28e0a870">video_outbuf_size</a> = 200000;</div>
<div class="line">        <a class="code" href="vnc2mpg_8c.html#af6c914e8831b6f96e33a3b61324e459a">video_outbuf</a> = malloc(<a class="code" href="vnc2mpg_8c.html#a7933dd760b6ead0ba5b7fc2a28e0a870">video_outbuf_size</a>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* allocate the encoded raw picture */</span></div>
<div class="line">    picture = <a class="code" href="vnc2mpg_8c.html#add9b0822c69abf813cf6e35bae8bd5e0">alloc_picture</a>(c-&gt;pix_fmt, c-&gt;width, c-&gt;height);</div>
<div class="line">    <span class="keywordflow">if</span> (!picture) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not allocate picture\n&quot;</span>);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* if the output format is not RGB565, then a temporary RGB565</span></div>
<div class="line"><span class="comment">       picture is needed too. It is then converted to the required</span></div>
<div class="line"><span class="comment">       output format */</span></div>
<div class="line">    <a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a> = NULL;</div>
<div class="line">    <span class="keywordflow">if</span> (c-&gt;pix_fmt != PIX_FMT_RGB565) {</div>
<div class="line">        <a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a> = <a class="code" href="vnc2mpg_8c.html#add9b0822c69abf813cf6e35bae8bd5e0">alloc_picture</a>(PIX_FMT_RGB565, c-&gt;width, c-&gt;height);</div>
<div class="line">        <span class="keywordflow">if</span> (!<a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a>) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not allocate temporary picture\n&quot;</span>);</div>
<div class="line">            exit(1);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> <a name="a11"></a><a class="code" href="vnc2mpg_8c.html#a3be0bed5fda7324de9ea8ee4aced2b24">write_video_frame</a>(AVFormatContext *oc, AVStream *st)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> out_size, ret;</div>
<div class="line">    AVCodecContext *c;</div>
<div class="line">    AVFrame *picture_ptr;</div>
<div class="line">   </div>
<div class="line"><span class="preprocessor">#if LIBAVFORMAT_BUILD&lt;4629</span></div>
<div class="line"><span class="preprocessor"></span>    c = &amp;st-&gt;codec;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    c = st-&gt;codec;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    </div>
<div class="line">        <span class="keywordflow">if</span> (c-&gt;pix_fmt != PIX_FMT_RGB565) {</div>
<div class="line">            <span class="comment">/* as we only generate a RGB565 picture, we must convert it</span></div>
<div class="line"><span class="comment">               to the codec pixel format if needed */</span></div>
<div class="line">            img_convert((AVPicture *)picture, c-&gt;pix_fmt, </div>
<div class="line">                        (AVPicture *)<a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a>, PIX_FMT_RGB565,</div>
<div class="line">                        c-&gt;width, c-&gt;height);</div>
<div class="line">        }</div>
<div class="line">        picture_ptr = <a class="code" href="vnc2mpg_8c.html#a65f6cfcea30372e03b387bd67c2f8a8d">picture</a>;</div>
<div class="line"></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (oc-&gt;oformat-&gt;flags &amp; AVFMT_RAWPICTURE) {</div>
<div class="line">        <span class="comment">/* raw video case. The API will change slightly in the near</span></div>
<div class="line"><span class="comment">           futur for that */</span></div>
<div class="line">        AVPacket pkt;</div>
<div class="line">        av_init_packet(&amp;pkt);</div>
<div class="line">        </div>
<div class="line">        pkt.flags |= PKT_FLAG_KEY;</div>
<div class="line">        pkt.stream_index= st-&gt;index;</div>
<div class="line">        pkt.data= (uint8_t *)picture_ptr;</div>
<div class="line">        pkt.size= <span class="keyword">sizeof</span>(AVPicture);</div>
<div class="line">        </div>
<div class="line">        ret = av_write_frame(oc, &amp;pkt);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">/* encode the image */</span></div>
<div class="line">        out_size = avcodec_encode_video(c, <a class="code" href="vnc2mpg_8c.html#af6c914e8831b6f96e33a3b61324e459a">video_outbuf</a>, <a class="code" href="vnc2mpg_8c.html#a7933dd760b6ead0ba5b7fc2a28e0a870">video_outbuf_size</a>, picture_ptr);</div>
<div class="line">        <span class="comment">/* if zero size, it means the image was buffered */</span></div>
<div class="line">        <span class="keywordflow">if</span> (out_size != 0) {</div>
<div class="line">            AVPacket pkt;</div>
<div class="line">            av_init_packet(&amp;pkt);</div>
<div class="line">            </div>
<div class="line">            pkt.pts= c-&gt;coded_frame-&gt;pts;</div>
<div class="line">            <span class="keywordflow">if</span>(c-&gt;coded_frame-&gt;key_frame)</div>
<div class="line">                pkt.flags |= PKT_FLAG_KEY;</div>
<div class="line">            pkt.stream_index= st-&gt;index;</div>
<div class="line">            pkt.data= <a class="code" href="vnc2mpg_8c.html#af6c914e8831b6f96e33a3b61324e459a">video_outbuf</a>;</div>
<div class="line">            pkt.size= out_size;</div>
<div class="line">            </div>
<div class="line">            <span class="comment">/* write the compressed frame in the media file */</span></div>
<div class="line">            ret = av_write_frame(oc, &amp;pkt);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            ret = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (ret != 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Error while writing video frame\n&quot;</span>);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="vnc2mpg_8c.html#afd3bfa5add6477abed3eaa362c5702b4">frame_count</a>++;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> <a name="a12"></a><a class="code" href="vnc2mpg_8c.html#ae899ea36d70f8f87dd13fdcfd10da53e">close_video</a>(AVFormatContext *oc, AVStream *st)</div>
<div class="line">{</div>
<div class="line">    avcodec_close(st-&gt;codec);</div>
<div class="line">    av_free(picture-&gt;data[0]);</div>
<div class="line">    av_free(picture);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a>) {</div>
<div class="line">        av_free(<a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a>-&gt;data[0]);</div>
<div class="line">        av_free(<a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a>);</div>
<div class="line">    }</div>
<div class="line">    av_free(<a class="code" href="vnc2mpg_8c.html#af6c914e8831b6f96e33a3b61324e459a">video_outbuf</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *filename;</div>
<div class="line"><span class="keyword">static</span> AVOutputFormat *fmt;</div>
<div class="line"><span class="keyword">static</span> AVFormatContext *oc;</div>
<div class="line"><span class="keyword">static</span> AVStream *video_st;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">double</span> video_pts;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> movie_open(<span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h) {</div>
<div class="line">    <span class="keywordflow">if</span> (fmt-&gt;video_codec != CODEC_ID_NONE) {</div>
<div class="line">        video_st = <a class="code" href="vnc2mpg_8c.html#a0f40e7e12b79ca55afa9a45a278baca2">add_video_stream</a>(oc, fmt-&gt;video_codec, w, h);</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">            <span class="keywordflow">return</span> 1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* set the output parameters (must be done even if no</span></div>
<div class="line"><span class="comment">       parameters). */</span></div>
<div class="line">    <span class="keywordflow">if</span> (av_set_parameters(oc, NULL) &lt; 0) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Invalid output format parameters\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 2;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    dump_format(oc, 0, filename, 1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* now that all the parameters are set, we can open the audio and</span></div>
<div class="line"><span class="comment">       video codecs and allocate the necessary encode buffers */</span></div>
<div class="line">    <span class="keywordflow">if</span> (video_st)</div>
<div class="line">        <a class="code" href="vnc2mpg_8c.html#a600bf2cf174c8560ef9d88c3e0b8aa64">open_video</a>(oc, video_st);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* open the output file, if needed */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!(fmt-&gt;flags &amp; AVFMT_NOFILE)) {</div>
<div class="line">        <span class="keywordflow">if</span> (url_fopen(&amp;oc-&gt;pb, filename, URL_WRONLY) &lt; 0) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Could not open &#39;%s&#39;\n&quot;</span>, filename);</div>
<div class="line">            <span class="keywordflow">return</span> 3;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* write the stream header, if any */</span></div>
<div class="line">    av_write_header(oc);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> movie_close() {</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">     <span class="comment">/* close each codec */</span></div>
<div class="line">    <a class="code" href="vnc2mpg_8c.html#ae899ea36d70f8f87dd13fdcfd10da53e">close_video</a>(oc, video_st);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* write the trailer, if any */</span></div>
<div class="line">    av_write_trailer(oc);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* free the streams */</span></div>
<div class="line">    <span class="keywordflow">for</span>(i = 0; i &lt; oc-&gt;nb_streams; i++) {</div>
<div class="line">        av_freep(&amp;oc-&gt;streams[i]);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!(fmt-&gt;flags &amp; AVFMT_NOFILE)) {</div>
<div class="line">        <span class="comment">/* close the output file */</span></div>
<div class="line">        url_fclose(&amp;oc-&gt;pb);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* free the stream */</span></div>
<div class="line">    av_free(oc);</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rfbproto_8h.html#a329f406ebc51f975c9df984a6b98c74d">rfbBool</a> quit=<a name="a13"></a><a class="code" href="rfbproto_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> signal_handler(<span class="keywordtype">int</span> signal) {</div>
<div class="line">        fprintf(stderr,<span class="stringliteral">&quot;Cleaning up.\n&quot;</span>);</div>
<div class="line">        quit=<a name="a14"></a><a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/**************************************************************/</span></div>
<div class="line"><span class="comment">/* VNC callback functions */</span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="rfbproto_8h.html#a329f406ebc51f975c9df984a6b98c74d">rfbBool</a> resize(<a name="_a15"></a><a class="code" href="structrfb_client.html">rfbClient</a>* client) {</div>
<div class="line">        <span class="keyword">static</span> <a class="code" href="rfbproto_8h.html#a329f406ebc51f975c9df984a6b98c74d">rfbBool</a> first=<a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line">        <span class="keywordflow">if</span>(!first) {</div>
<div class="line">                movie_close();</div>
<div class="line">                perror(<span class="stringliteral">&quot;I don&#39;t know yet how to change resolutions!\n&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        movie_open(client-&gt;<a name="a16"></a><a class="code" href="structrfb_client.html#a2474a5474cbff19523a51eb1de01cda4">width</a>, client-&gt;<a name="a17"></a><a class="code" href="structrfb_client.html#ad12fc34ce789bce6c8a05d8a17138534">height</a>);</div>
<div class="line">        signal(SIGINT,signal_handler);</div>
<div class="line">        <span class="keywordflow">if</span>(<a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a>)</div>
<div class="line">                client-&gt;<a name="a18"></a><a class="code" href="structrfb_client.html#a9a2fdf82b1d05e2a1cbcb68ad1237ae4">frameBuffer</a>=<a class="code" href="vnc2mpg_8c.html#a18d7c57751aa2bc0fd075918cf0c92d0">tmp_picture</a>-&gt;data[0];</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">                client-&gt;<a class="code" href="structrfb_client.html#a9a2fdf82b1d05e2a1cbcb68ad1237ae4">frameBuffer</a>=picture-&gt;data[0];</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> update(<a class="code" href="structrfb_client.html">rfbClient</a>* client,<span class="keywordtype">int</span> x,<span class="keywordtype">int</span> y,<span class="keywordtype">int</span> w,<span class="keywordtype">int</span> h) {</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/**************************************************************/</span></div>
<div class="line"><span class="comment">/* media file output */</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a name="a19"></a><a class="code" href="_s_d_lvncviewer_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    time_t stop=0;</div>
<div class="line">    <a class="code" href="structrfb_client.html">rfbClient</a>* client;</div>
<div class="line">    <span class="keywordtype">int</span> i,j;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* get a vnc client structure (don&#39;t connect yet). */</span></div>
<div class="line">    client = <a name="a20"></a><a class="code" href="group__libvncclient__api.html#ga13e0666f04539bf2a0f36af961e9506a" title="Allocates and returns a pointer to an rfbClient structure. ">rfbGetClient</a>(5,3,2);</div>
<div class="line">    client-&gt;<a name="a21"></a><a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a22"></a><a class="code" href="structrfb_pixel_format.html#ae15e89a5090279dd2fca4453a3a3f20a">redShift</a>=11; client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a23"></a><a class="code" href="structrfb_pixel_format.html#a07ca53b709f723484418082b4511540a">redMax</a>=31;</div>
<div class="line">    client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a24"></a><a class="code" href="structrfb_pixel_format.html#a5f4558aed9088231e0fddf264f292d60">greenShift</a>=5; client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a25"></a><a class="code" href="structrfb_pixel_format.html#a188ea8035a1b7b1c177341b6c75edae3">greenMax</a>=63;</div>
<div class="line">    client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a26"></a><a class="code" href="structrfb_pixel_format.html#aa0f291475e78e329f47c870e3a540596">blueShift</a>=0; client-&gt;<a class="code" href="structrfb_client.html#afe12707797380d4d71f0869554206d3f">format</a>.<a name="a27"></a><a class="code" href="structrfb_pixel_format.html#a24b0b5716ded786484ea655d7ed1a4d1">blueMax</a>=31;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize libavcodec, and register all codecs and formats */</span></div>
<div class="line">    av_register_all();</div>
<div class="line">   </div>
<div class="line">    <span class="keywordflow">if</span>(!strncmp(argv[argc-1],<span class="stringliteral">&quot;:&quot;</span>,1) ||</div>
<div class="line">        !strncmp(argv[argc-1],<span class="stringliteral">&quot;127.0.0.1&quot;</span>,9) ||</div>
<div class="line">        !strncmp(argv[argc-1],<span class="stringliteral">&quot;localhost&quot;</span>,9))</div>
<div class="line">            client-&gt;<a name="a28"></a><a class="code" href="structrfb_client.html#aeabb297057c511dc1697a7f69f583fd5">appData</a>.<a name="a29"></a><a class="code" href="struct_app_data.html#ae506613d87997c3abbc3869fa0b0cff2">encodingsString</a>=<span class="stringliteral">&quot;raw&quot;</span>;</div>
<div class="line"></div>
<div class="line">    filename=0;</div>
<div class="line">    <span class="keywordflow">for</span>(i=1;i&lt;argc;i++) {</div>
<div class="line">            j=i;</div>
<div class="line">            <span class="keywordflow">if</span>(argc&gt;i+1 &amp;&amp; !strcmp(<span class="stringliteral">&quot;-o&quot;</span>,argv[i])) {</div>
<div class="line">                    filename=argv[2];</div>
<div class="line">                    j+=2;</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(argc&gt;i+1 &amp;&amp; !strcmp(<span class="stringliteral">&quot;-t&quot;</span>,argv[i])) {</div>
<div class="line">                    stop=time(0)+atoi(argv[i+1]);</div>
<div class="line">                    j+=2;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span>(j&gt;i) {</div>
<div class="line">                    argc-=j-i;</div>
<div class="line">                    memmove(argv+i,argv+j,(argc-i)*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>*));</div>
<div class="line">                    i--;</div>
<div class="line">            }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">  </div>
<div class="line">    <span class="comment">/* auto detect the output format from the name. default is</span></div>
<div class="line"><span class="comment">       mpeg. */</span></div>
<div class="line">    fmt = filename?guess_format(NULL, filename, NULL):0;</div>
<div class="line">    <span class="keywordflow">if</span> (!fmt) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Could not deduce output format from file extension: using MPEG.\n&quot;</span>);</div>
<div class="line">        fmt = guess_format(<span class="stringliteral">&quot;mpeg&quot;</span>, NULL, NULL);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!fmt) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Could not find suitable output format\n&quot;</span>);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* allocate the output media context */</span></div>
<div class="line">    oc = av_alloc_format_context();</div>
<div class="line">    <span class="keywordflow">if</span> (!oc) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Memory error\n&quot;</span>);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line">    oc-&gt;oformat = fmt;</div>
<div class="line">    snprintf(oc-&gt;filename, <span class="keyword">sizeof</span>(oc-&gt;filename), <span class="stringliteral">&quot;%s&quot;</span>, filename);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* add the audio and video streams using the default format codecs</span></div>
<div class="line"><span class="comment">       and initialize the codecs */</span></div>
<div class="line">    video_st = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* open VNC connection */</span></div>
<div class="line">    client-&gt;<a name="a30"></a><a class="code" href="structrfb_client.html#af0100dc33c8e9078e06992240d7c6861">MallocFrameBuffer</a>=resize;</div>
<div class="line">    client-&gt;<a name="a31"></a><a class="code" href="structrfb_client.html#a2a826e6f505e2a569dca4e56822ad65e">GotFrameBufferUpdate</a>=update;</div>
<div class="line">    <span class="keywordflow">if</span>(!<a name="a32"></a><a class="code" href="group__libvncclient__api.html#gabb2299d1644f3cf38544eb97d2356475" title="Initializes the client. ">rfbInitClient</a>(client,&amp;argc,argv)) {</div>
<div class="line">        printf(<span class="stringliteral">&quot;usage: %s [-o output_file] [-t seconds] server:port\n&quot;</span></div>
<div class="line">               <span class="stringliteral">&quot;Shoot a movie from a VNC server.\n&quot;</span>, argv[0]);</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span>(client-&gt;<a name="a33"></a><a class="code" href="structrfb_client.html#af334bd1dd0db3e931fb511c449529b42" title="if -1, then use file recorded by vncrec ">serverPort</a>==-1)</div>
<div class="line">      client-&gt;<a name="a34"></a><a class="code" href="structrfb_client.html#a3313d5ac8eaa5ae7d0fde04ef23f3872">vncRec</a>-&gt;<a name="a35"></a><a class="code" href="structrfb_v_n_c_rec.html#af8177bdfcbc86424849f0ec325865c38">doNotSleep</a> = <a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; <span class="comment">/* vncrec playback */</span></div>
<div class="line">    </div>
<div class="line">     <span class="comment">/* main loop */</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span>(!quit) {</div>
<div class="line">        <span class="keywordtype">int</span> i=<a name="a36"></a><a class="code" href="group__libvncclient__api.html#ga154dcdd94ef439dc8d57dd14bf1e1c59" title="Waits for an RFB message to arrive from the server. ">WaitForMessage</a>(client,1000000/<a class="code" href="vnc2mpg_8c.html#ad0fa7a6ac51a4021276c0a04dfe2283b">STREAM_FRAME_RATE</a>);</div>
<div class="line">        <span class="keywordflow">if</span>(i&lt;0) {</div>
<div class="line">                movie_close();</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span>(i)</div>
<div class="line">                <span class="keywordflow">if</span>(!<a name="a37"></a><a class="code" href="group__libvncclient__api.html#gaa9ba8ed8e74e27e9c4095e0190d2aad9" title="Handles messages from the RFB server. ">HandleRFBServerMessage</a>(client))</div>
<div class="line">                        quit=<a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="comment">/* compute current audio and video time */</span></div>
<div class="line">                video_pts = (double)video_st-&gt;pts.val * video_st-&gt;time_base.num / video_st-&gt;time_base.den;</div>
<div class="line"></div>
<div class="line">                <span class="comment">/* write interleaved audio and video frames */</span></div>
<div class="line">                <a class="code" href="vnc2mpg_8c.html#a3be0bed5fda7324de9ea8ee4aced2b24">write_video_frame</a>(oc, video_st);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span>(stop!=0 &amp;&amp; stop&lt;time(0))</div>
<div class="line">                quit=<a class="code" href="rfbproto_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    movie_close();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Apr 5 2014 07:14:26 for LibVNCServer/LibVNCClient by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.4
</small></address>
</body>
</html>
